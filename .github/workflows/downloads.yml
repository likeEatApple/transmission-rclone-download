name: AutoDownloader
on:
  workflow_dispatch
  #pull
jobs:
  AutoDownloaderProcess:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2.1.0
    - name: Enable BBR
      run: |

        sudo uname -a
        sudo lsmod
        sudo sysctl net.ipv4.tcp_congestion_control
        echo "net.core.default_qdisc=fq" | sudo tee -a /etc/sysctl.conf
        echo "net.ipv4.tcp_congestion_control=bbr" | sudo tee -a /etc/sysctl.conf
        sudo sysctl   -p
        sudo sysctl net.ipv4.tcp_congestion_control
        sudo lsmod
    - name: Rclone Install
      run: curl https://rclone.org/install.sh | sudo bash
    - name: yt-dlp Install
      run: sudo curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp && sudo chmod a+rx /usr/local/bin/yt-dlp

    - name:  aria2c install 
      run: sudo apt-get install aria2
    - name: docker Install
      run: docker run -d --name=webdav-aliyundriver --restart=always -p 127.0.0.1:8080:8080  -v /etc/localtime:/etc/localtime -e TZ="Asia/Shanghai" -e ALIYUNDRIVE_REFRESH_TOKEN="${{ secrets.ALI_TOKEN}}" -e ALIYUNDRIVE_AUTH_PASSWORD="admin" -e JAVA_OPTS="-Xmx1g" zx5253/webdav-aliyundriver
    - name: Inject Rclone&Transmission config
      run: |
        mkdir -p ~/.config/rclone/
        cat >  ~/.config/rclone/rclone.conf  << EOF
        ${{ secrets.RCLONE_CONF_ALI }}
        EOF


    - name: mkdir
      run: |
        sudo mkdir /root/downloads
    - name: yt-dlp_Downloading_File
      run: |
        sudo cat >  ~/1.txt  << EOF
        ${{ secrets.youtubedl_file }}
        EOF
        sudo cat ~/1.txt
        sudo wget https://raw.githubusercontent.com/likeEatingApples/transmission-rclone-download/youtube-dl-aliwangpan/1.txt -O /root/1.txt
        sudo yt-dlp  -v --external-downloader aria2c --external-downloader-args "-s 6 -x 6 -k 1M --timeout=60 --max-tries=10 --retry-wait=20"  --ignore-errors -o '/root/downloads/%(title)s-%(id)s.%(ext)s' --batch-file ~/1.txt
        #sudo youtube-dl  -v   --ignore-errors -o '/root/downloads/%(title)s-%(id)s.%(ext)s' --batch-file ~/1.txt



    - name: Rclone Synchronizing file
      run: |
        #sudo rclone copy /root/downloads ${{ secrets.D_ALI}} -P --bwlimit 20M
        #sudo rclone copy /root/downloads aliyunpan:/bilibili/ -P --bwlimit 20M
        #sudo rclone copy /root/downloads  aliyunpan:/bilibili/${{ secrets.aliyunpan_bilibili}} -P --bwlimit 20M
        sudo rclone copy /root/downloads  aliyunpan_crypt:/bilibili/${{ secrets.aliyunpan_bilibili}} -P --bwlimit 20M


