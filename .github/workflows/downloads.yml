name: AutoDownloader
on:
  workflow_dispatch
  #pull
jobs:
  AutoDownloaderProcess:
    runs-on: ubuntu-latest
    steps:
    - name: Maximize build space
      uses: easimon/maximize-build-space@master
      with:
          root-reserve-mb: 256
          swap-size-mb: 256
          remove-dotnet: 'true'
          temp-reserve-mb: 64
          remove-android: 'true'
          remove-haskell: 'true'
    - uses: actions/checkout@v2.1.0
    - name: Enable BBR
      run: |

        sudo uname -a
        sudo lsmod
        sudo sysctl net.ipv4.tcp_congestion_control
        echo "net.core.default_qdisc=fq" | sudo tee -a /etc/sysctl.conf
        echo "net.ipv4.tcp_congestion_control=bbr" | sudo tee -a /etc/sysctl.conf
        sudo sysctl   -p
        sudo sysctl net.ipv4.tcp_congestion_control
        sudo lsmod
    - name: Rclone Install
      run: curl https://rclone.org/install.sh | sudo bash
    - name: Transmission-cli Install
      run: sudo apt install -y  transmission-cli
    - name: docker Install
      run: docker run -d --name=webdav-aliyundriver --restart=always -p 127.0.0.1:8080:8080  -v /etc/localtime:/etc/localtime -e TZ="Asia/Shanghai" -e ALIYUNDRIVE_REFRESH_TOKEN="${{ secrets.ALI_TOKEN}}" -e ALIYUNDRIVE_AUTH_PASSWORD="admin" -e JAVA_OPTS="-Xmx1g" mxy9/webdav-aliyundriver
    - name: Inject Rclone&Transmission config
      run: |
        mkdir -p ~/.config/rclone/
        cat >  ~/.config/rclone/rclone.conf  << EOF
        ${{ secrets.RCLONE_CONF_ALI }}
        EOF
        mkdir -p ~/.config/transmission/
        cp settings.json  ~/.config/transmission/settings.json
        sed  -i "s|/downloads|$GITHUB_WORKSPACE/downloads|g" ~/.config/transmission/settings.json
        cat ~/.config/transmission/settings.json
        #wget https://raw.githubusercontent.com/likeEatApple/transmission-rclone-download/main/settings.json -O ~/.config/transmission/settings.json

    - name: mkdir
      run: |
        sudo mkdir $GITHUB_WORKSPACE/downloads && sudo chmod 777 $GITHUB_WORKSPACE/downloads
        sudo df -h
        df -h $GITHUB_WORKSPACE/downloads
        ls ~/.config/transmission/
        
    - name: transmission_Downloading_File
      run: |
         transmission-cli "${{ secrets.URL}}"

        



    - name: Rclone Synchronizing file
      run: |
        rclone copy $GITHUB_WORKSPACE/downloads ${{ secrets.D_ALI}} -P --bwlimit 20M


