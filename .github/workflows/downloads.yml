name: AutoDownloader
on:
  workflow_dispatch
  #pull
jobs:
  AutoDownloaderProcess:
    runs-on: ubuntu-latest
    steps:
    - name: Maximize build space
      uses: easimon/maximize-build-space@master
      with:
          root-reserve-mb: 512
          swap-size-mb: 256
          remove-dotnet: 'true'
          temp-reserve-mb: 64
          remove-android: 'true'
          remove-haskell: 'true'
    - uses: actions/checkout@v2.1.0
    - name: Enable BBR
      run: |

        sudo uname -a
        sudo lsmod
        sudo sysctl net.ipv4.tcp_congestion_control
        echo "net.core.default_qdisc=fq" | sudo tee -a /etc/sysctl.conf
        echo "net.ipv4.tcp_congestion_control=bbr" | sudo tee -a /etc/sysctl.conf
        sudo sysctl   -p
        sudo sysctl net.ipv4.tcp_congestion_control
        sudo lsmod
    - name: Rclone Install
      run: curl https://rclone.org/install.sh | sudo bash
    - name: yt-dlp Install
      run: sudo curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp && sudo chmod a+rx /usr/local/bin/yt-dlp


    - name: docker aliyunpan Install
      run: docker run -d --name=webdav-aliyundriver --restart=always -p 127.0.0.1:8080:8080  -v /etc/localtime:/etc/localtime -e TZ="Asia/Shanghai" -e ALIYUNDRIVE_REFRESH_TOKEN="${{ secrets.ALI_TOKEN}}" -e ALIYUNDRIVE_AUTH_PASSWORD="admin" -e JAVA_OPTS="-Xmx1g" mxy9/webdav-aliyundriver
    - name: Inject Rclone config
      run: |
        mkdir -p ~/.config/rclone/
        cat >  ~/.config/rclone/rclone.conf  << EOF
        ${{ secrets.RCLONE_CONF_ALI }}
        EOF


    - name: mkdir
      run: |
        sudo mkdir $GITHUB_WORKSPACE/downloads
        df -h $GITHUB_WORKSPACE
    - name: yt-dlp_Downloading_File
      run: |
        sudo cat >  ~/1.txt  << EOF
        ${{ secrets.youtubedl_file }}
        EOF
        sudo cat ~/1.txt

        (sudo yt-dlp  -v --external-downloader aria2c --external-downloader-args "-s 6 -x 6 -k 1M --timeout=60 --max-tries=10 --retry-wait=20"  --ignore-errors -o $GITHUB_WORKSPACE'/downloads/%(title)s-%(id)s.%(ext)s' --batch-file ~/1.txt ) || true
    



    - name: Rclone Synchronizing file
      run: |
        #sudo rclone copy /root/downloads ${{ secrets.D_ALI}} -P --bwlimit 20M
        #sudo rclone copy /root/downloads aliyunpan:/bilibili/ -P --bwlimit 20M
        #sudo rclone copy /root/downloads  aliyunpan:/yt-dlp/${{ secrets.aliyunpan_bilibili}} -P --bwlimit 20M
        (sudo rclone copy $GITHUB_WORKSPACE/downloads  aliyunpan_crypt://${{ secrets.aliyunpan_dir}} -P --bwlimit 20M -vv) || true

